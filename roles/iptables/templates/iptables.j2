#jinja2: lstrip_blocks: True, trim_blocks: True
#########################################################################
####     AUTO GENERATED by Ansible, DO NOT EDIT                      ####
#########################################################################

*nat
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 10.0.0.0/8 -o eth+ -j MASQUERADE
COMMIT


*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0
:OUTPUT ACCEPT [0:0]

:LogDrop -
:LogDropFwd -
:LogAccept -
:LogAcceptFwd -

-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT

## OSPF to the VPN interfaces
-A INPUT -i tun+ -p ospf -j LogAccept

## Access to the VIPs
-A INPUT -i tun+ -m state --state NEW -p tcp -d 10.3.2.0/24 -j LogAccept
-A INPUT -i tun+ -m state --state NEW -p udp -d 10.3.2.0/24 -j LogAccept

## SSH from anywhere to any local interface
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j LogAccept

## VPN connections
{% for vpn, vpninfo in vpn.site_to_site.items() %}
-A INPUT -i eth0 -m state --state NEW -m udp -p udp --dport {{vpninfo.port}} -j LogAccept
{% endfor %}
{% for vpn, protos in vpn.roaming.items() %}
  {% for proto, vpninfo in protos.items() %}
-A INPUT -i eth0 -m state --state NEW -m {{proto}} -p {{proto}} --dport {{vpninfo.port}} -j LogAccept
  {% endfor %}
{% endfor %}

## Service ports
{% for port in firewall.ports %}
-A INPUT -i eth0 -m state --state NEW -m tcp -p tcp --dport {{port}} -j LogAccept
{% endfor %}

-A INPUT -j LogDrop

-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -p icmp -j ACCEPT
-A FORWARD -i lo -j ACCEPT
-A FORWARD -i tun+ -j LogAcceptFwd
-A FORWARD -j LogDrop


-A LogDrop -m limit --limit 10/second --limit-burst 20 -j LOG --log-level 4 --log-prefix "DROP_INPUT"
-A LogDrop -j DROP
-A LogDropFwd -m limit --limit 10/second --limit-burst 20 -j LOG --log-level 4 --log-prefix "DROP_FORWARD"
-A LogDropFwd -j DROP
-A LogAccept -m limit --limit 10/second --limit-burst 20 -j LOG --log-level 4 --log-prefix "ACCEPT_INPUT"
-A LogAccept -j ACCEPT
-A LogAcceptFwd -m limit --limit 10/second --limit-burst 20 -j LOG --log-level 4 --log-prefix "ACCEPT_FORWARD"
-A LogAcceptFwd -j ACCEPT


COMMIT
